name: Export incremental Snowflake changes
on:
 workflow_dispatch:
   inputs:
     schemas:
       description: "Space-separated schema list"
       required: true
       default: "COMETL_SFDC_CONTROL COMETL_SFDC_STAGING COMETL_SFDC_SYNC COMETL_SFDC_REPLICATION COMETL_SFDC_LANDING"
jobs:
 export:
   runs-on: ubuntu-latest
   permissions:
     contents: write
   steps:
     - name: Checkout
       uses: actions/checkout@v4
       with:
         fetch-depth: 0
     - name: Install Java
       uses: actions/setup-java@v4
       with:
         distribution: temurin
         java-version: "17"
     - name: Install Liquibase
       run: |
         set -euo pipefail
         LIQUIBASE_VERSION="4.29.2"
         curl -sL "https://github.com/liquibase/liquibase/releases/download/v${LIQUIBASE_VERSION}/liquibase-${LIQUIBASE_VERSION}.tar.gz" -o /tmp/liquibase.tgz
         sudo mkdir -p /opt/liquibase
         sudo tar -xzf /tmp/liquibase.tgz -C /opt/liquibase
         sudo ln -sf /opt/liquibase/liquibase /usr/local/bin/liquibase
         liquibase --version
     - name: Install Snowflake JDBC + Extension
       run: |
         set -euo pipefail
         mkdir -p lib
         curl -sL -o lib/snowflake-jdbc.jar \
          https://repo1.maven.org/maven2/net/snowflake/snowflake-jdbc/3.16.1/snowflake-jdbc-3.16.1.jar
         curl -sL -o lib/liquibase-snowflake.jar \
          https://repo1.maven.org/maven2/org/liquibase/ext/liquibase-snowflake/4.29.2/liquibase-snowflake-4.29.2.jar
         sudo mkdir -p /opt/liquibase/lib
         sudo cp lib/*.jar /opt/liquibase/lib/
     - name: Enable BouncyCastle
       run: |
         echo "JAVA_OPTS=-Dnet.snowflake.jdbc.enableBouncyCastle=true" >> $GITHUB_ENV
     - name: Create encrypted .p8 key
       env:
         P8_PEM: ${{ secrets.SNOWFLAKE_PRIVATE_KEY_P8_PEM }}
       run: |
         set -euo pipefail
         printf "%s" "$P8_PEM" > snowflake_key.p8
         chmod 600 snowflake_key.p8
         head -n 1 snowflake_key.p8
     - name: Export incremental changes -> new branch
       env:
         SF_USER: ${{ secrets.SNOWFLAKE_USER }}
         SF_JDBC_HOST: ${{ secrets.SNOWFLAKE_JDBC_HOST }}
         SF_KEY_PWD: ${{ secrets.SNOWFLAKE_PRIVATE_KEY_PASSPHRASE }}
         SF_DB: ${{ secrets.SNOWFLAKE_DATABASE }}
         SF_WAREHOUSE: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
         SF_ROLE: ${{ secrets.SNOWFLAKE_ROLE }}
         SCHEMAS: ${{ inputs.schemas }}
       run: |
         set -euo pipefail
         DRIVER="net.snowflake.client.jdbc.SnowflakeDriver"
         TIMESTAMP=$(date +"%Y%m%d_%H%M")
         BRANCH="db-export-${TIMESTAMP}"
         git config user.name "github-actions[bot]"
         git config user.email "github-actions[bot]@users.noreply.github.com"
         git checkout -b "$BRANCH"
         mkdir -p snowflake/snapshots
         mkdir -p snowflake/ddls snowflake/dmls snowflake/procs
         route_changes () {
           RAW="$1"
           DDL="$2"
           DML="$3"
           PROCS="$4"
           awk '
           /^--/ {print > ddl; print > dml; print > procs; next}
           {
             line=toupper($0)
             if (line ~ /^DROP[[:space:]]+/) next
             if (line ~ /(CREATE|ALTER).* (PROCEDURE|FUNCTION)/){
               print > procs; next
             }
             if (line ~ /^(INSERT|UPDATE|DELETE|MERGE|COPY)/){
               print > dml; next
             }
             if (line ~ /(CREATE|ALTER|GRANT|REVOKE)/){
               print > ddl; next
             }
             print > ddl
           }' ddl="$DDL" dml="$DML" procs="$PROCS" "$RAW"
         }
         for SCHEMA in $SCHEMAS; do
           SNAPSHOT="snowflake/snapshots/${SCHEMA}.json"
           RAW="/tmp/${TIMESTAMP}_${SCHEMA}_raw.sql"
           # ✅ FIXED PARAM NAME HERE
           PARAMS="schema=${SCHEMA}&private_key_file=$(pwd)/snowflake_key.p8&private_key_file_pwd=${SF_KEY_PWD}"
           [ -n "${SF_DB:-}" ] && PARAMS="db=${SF_DB}&${PARAMS}"
           [ -n "${SF_WAREHOUSE:-}" ] && PARAMS="warehouse=${SF_WAREHOUSE}&${PARAMS}"
           [ -n "${SF_ROLE:-}" ] && PARAMS="role=${SF_ROLE}&${PARAMS}"
           # ✅ FIXED URL FORMAT
           LIVE_URL="${SF_JDBC_HOST%/}/?${PARAMS}"
           echo "Processing $SCHEMA"
           if [ ! -f "$SNAPSHOT" ]; then
             liquibase --driver="$DRIVER" \
             --url="$LIVE_URL" \
             --username="$SF_USER" \
             snapshot \
             --snapshotFormat=json \
             --outputFile="$SNAPSHOT"
             git add "$SNAPSHOT"
             continue
           fi
           liquibase --driver="$DRIVER" \
             --url="offline:snowflake?snapshot=$SNAPSHOT" \
             --referenceUrl="$LIVE_URL" \
             --referenceUsername="$SF_USER" \
             diffChangeLog \
             --changeLogFile="$RAW"
           if [ ! -s "$RAW" ]; then
             rm -f "$RAW"
             continue
           fi
           DDL_OUT="snowflake/ddls/${TIMESTAMP}_${SCHEMA}.sql"
           DML_OUT="snowflake/dmls/${TIMESTAMP}_${SCHEMA}.sql"
           PROC_OUT="snowflake/procs/${TIMESTAMP}_${SCHEMA}.sql"
           route_changes "$RAW" "$DDL_OUT" "$DML_OUT" "$PROC_OUT"
           liquibase --driver="$DRIVER" \
             --url="$LIVE_URL" \
             --username="$SF_USER" \
             snapshot \
             --snapshotFormat=json \
             --outputFile="$SNAPSHOT"
           git add "$SNAPSHOT"
           [ -f "$DDL_OUT" ] && git add "$DDL_OUT"
           [ -f "$DML_OUT" ] && git add "$DML_OUT"
           [ -f "$PROC_OUT" ] && git add "$PROC_OUT"
           rm -f "$RAW"
         done
         if git diff --cached --quiet; then
           echo "Nothing to commit"
           exit 0
         fi
         git commit -m "Incremental Snowflake export ${TIMESTAMP}"
         git push --set-upstream origin "$BRANCH"
         echo "Branch pushed $BRANCH"